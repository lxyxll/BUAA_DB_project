{% extends 'adminlte_base.html' %}
{% block title %}每日订单趋势{% endblock %}

{% block extra_css %}
<style>
  .card {
    background: rgba(255,255,255,.9);
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 15px;
    box-shadow: 0 4px 14px rgba(0,0,0,.06);
  }
  .card h4 { margin-top: 0; }
</style>
{% endblock %}

{% block content %}
<div class="panel panel-default">
  <div class="panel-heading">
    <strong><i class="fa fa-area-chart"></i> 每日订单量趋势</strong>
    <span class="pull-right" style="color:#888;">仅管理员可见</span>
  </div>

  <div class="panel-body">

    <div class="card">
      <h4>趋势图（完成订单数 / 天）</h4>
      <canvas id="monthlyOrdersChart" height="90"></canvas>
      <p style="color:#888; font-size:12px; margin-top:10px;">
        说明：统计口径为订单状态“完成”（或包含“完成”的状态）。
      </p>
    </div>

    <div class="card">
      <h4>明细数据</h4>
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>日期</th>
              <th>完成订单数</th>
            </tr>
          </thead>
          <tbody>
            {% for row in stats %}
              <tr>
                <td>{{ row.day }}</td>
                <td>{{ row.order_count }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" style="color:#888;">暂无数据</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div>
      <a class="btn btn-default" href="{% url 'market:stats_overview' %}">
        <i class="fa fa-arrow-left"></i> 返回总览统计
      </a>
    </div>

  </div>
</div>

{# 将后端 stats 安全注入为 JSON（兼容性更强的做法：escapejs） #}
<script id="monthly-orders-data" type="application/json">
  [
  {% for row in stats %}
    {"day":"{{ row.day|escapejs }}","order_count":{{ row.order_count }}}
    {% if not forloop.last %},{% endif %}
  {% endfor %}
  ]
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  var el = document.getElementById("monthly-orders-data");
  var canvas = document.getElementById("monthlyOrdersChart");
  if(!el || !canvas) return;

  var rows = [];
  try { rows = JSON.parse(el.textContent || "[]"); } catch(e) { rows = []; }

  var labels = rows.map(function(r){ return r.day; });
  var values = rows.map(function(r){ return Number(r.order_count || 0); });

  // 没数据就不画图（表格仍可看）
  if(labels.length === 0) return;

  new Chart(canvas, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "完成订单数",
        data: values,
        tension: 0.25
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });
})();
</script>
{% endblock %}
